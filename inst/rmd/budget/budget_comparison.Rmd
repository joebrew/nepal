---
output:
  html_document:
    theme: united
    highlight: tango
---




```{r setup, include=FALSE}
options(scipen=999)

library(knitr)
# Basic knitr options
opts_chunk$set(comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = F,
               fig.width = 7,
               fig.height = 5)
knit_engines$set(asis = function(options) {
  if (options$echo && options$eval) knit_child(text = options$code)
})
```

```{r}
library(leaflet)
library(leaflet.extras)
library(sp)
library(raster)
library(ggmap)
library(dplyr)
library(maptools)
library(rgdal)
library(RColorBrewer)
library(googlesheets)
library(knitr)
library(tidyr)
library(databrew)
library(readr)
# budget <- gs_title('Nepal DrOTS BNMT budget comparison')
# budget <- gs_read(budget)

budget <- 
  bind_rows(
    read_csv('budget_data/budget_2018-07-15.csv') %>%
      mutate(key = 'Old'),
    read_csv('budget_data/budget_2018-08-15.csv') %>%
      mutate(key = 'New')
  )

```

# BNMT budget comparison (July vs. August versions) {.tabset .tabset-fade} 

<img src="img/mountains_small.png" alt="logo" width='100%' style="float: center;align:center;">


## Total

### Funding guaranteed (phases 0-2)

- Old: `r sum(budget$usd[budget$partner == 'BNMT' & budget$phase <=2 & budget$key == 'Old'])`
- New: `r sum(budget$usd[budget$partner == 'BNMT' & budget$phase <=2 & budget$key == 'New'])`

### Funding not guaranteed (phases 3)

- Old: `r sum(budget$usd[budget$partner == 'BNMT' & budget$phase >=3 & budget$key == 'Old'])`
- New: `r sum(budget$usd[budget$partner == 'BNMT' & budget$phase >=3 & budget$key == 'New'])`

### Total (guaranteed and not guaranteed; phases 0-3)

- Old: `r sum(budget$usd[budget$partner == 'BNMT' & budget$key == 'Old'])`
- New: `r sum(budget$usd[budget$partner == 'BNMT' & budget$key == 'New'])`

## Differences by phase

### Overview

- Phase 1: Relative to the previous budget, more money would be allotted for phase 1 (ground operations) in order to account for the fact that it has increased from 6 to 8 months.
- Phase 2: Relative to the previous budget, less money has been allotted for phase 2 (air operations) in order to account for the fact that this phase has decreased in duration from 6 to 3 months.
- Phase 3: There is now a new phase 3 (bridge funding) which would entail 3 additional months (Jun-Aug 2019) of ground/air operations. Funding will be sought for this, but is not guaranteed.

### Visual

```{r}
x <- budget %>%
  filter(partner == 'BNMT') %>%
  group_by(phase, key) %>%
  summarise(usd = sum(usd))
left <- expand.grid(phase = 1:3,
                    key = c('New', 'Old'))
x <- left_join(left, x)
x$usd[is.na(x$usd)] <- 0
x$key <- factor(x$key, levels = c('Old', 'New'))

ggplot(data = x,
       aes(x = phase,
           y = usd,
           group = key)) +
  geom_bar(stat = 'identity',
           alpha = 0.7,
           position = position_dodge(width = 1),
           aes(fill = key)) +
  geom_label(aes(label = round(usd)),
             position = position_dodge(width = 1)) +
  scale_fill_manual(name = 'Version',
                    values = c('black','blue')) +
  theme_databrew() +
  labs(x = 'Phase',
       y = 'USD')
x <- x %>% spread(key = phase, value = usd)
names(x)[1] <- 'Budget version'
names(x)[2:4] <- paste0('Phase ', names(x)[2:4])
x %>% kable
```

## Differences by item

### Overview 

- Phase 1 is largely characterized by increases (due to increasing the period's length from 6 to 8 months), albeit only for on-the-ground / otherwise essential staff (ie, lab / field / district); increases were not made for non-field staff, assuming that they can go on "hiatus" for the 2 month period of August / September (ie, for "hiatus" staff, phase 1 still contains only 6 working months).

- Phase 2 is largely characterized by decreases in HR expenditures, due to the reduction in phase length from 6 to 3 months. Equipment and materials costs, as well as the costs of meetings, remain identical. Overhead remains identical (meaning that it's likely too large).

- Phase 3 consists solely of increases (since this phase did not exist before). However, funding for phase 3 is not yet guaranteed.

### Breakdown

The below shows an itemized comparison between the old and new budgets. Increases are in blue; decreases are in red. Note: 


```{r}
right <- 
  budget %>%
  filter(partner == 'BNMT') %>%
  group_by(item, phase) %>%
  summarise(old = sum(usd[key == 'Old']),
            new = sum(usd[key == 'New'])) %>%
  arrange(phase, item) %>%
  mutate(increase = old < new,
         decrease = old > new)
increase <- right$increase
decrease <- right$decrease
right$increase <- right$decrease <- NULL

names(right) <- Hmisc::capitalize(names(right))

library(kableExtra)
k <- kable(right) %>%
    kable_styling(full_width = F) %>%
  row_spec(which(decrease),
           bold = T,
           color = 'white',
           background = '#D7261E') %>%
  row_spec(which(increase),
           bold = T,
           color = 'white',
           background = '#008B8B')
k
```

## Raw data


### Live URLS

- Old (July 2018) budget: https://docs.google.com/spreadsheets/d/10bR5WRcS_jug_bVf-9nmoz0vm_4t0ke4zDF4Z1rlNa4/edit?usp=sharing

- New (August 2018) budget: https://docs.google.com/spreadsheets/d/1wYJ-yuZ3gmCr39dO3Gef0wv8R5pistgP0tOs8FbEcQI/edit#gid=0

### Old version

```{r}
prettify(budget %>% filter(key == 'Old'), 
         download_options = TRUE)
```

### New version


```{r}
prettify(budget %>% filter(key == 'New'), 
         download_options = TRUE)
```

