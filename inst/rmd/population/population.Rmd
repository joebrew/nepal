---
output:
  html_document:
    theme: united
    highlight: tango
---

```{r setup, include=FALSE}
options(scipen=999)

library(knitr)
# Basic knitr options
opts_chunk$set(comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = F,
               fig.width = 7,
               fig.height = 5)
knit_engines$set(asis = function(options) {
  if (options$echo && options$eval) knit_child(text = options$code)
})
```

```{r}
library(leaflet)
library(leaflet.extras)
library(sp)
library(raster)
library(ggmap)
library(dplyr)
library(maptools)
library(rgdal)
library(RColorBrewer)
library(googlesheets)
library(knitr)
library(tidyr)
library(databrew)
library(nepal)
library(rasterVis)
```

<img src="img/mountains_small.png" alt="logo" width='100%' style="float: center;align:center;">

# Pyuthan Maps {.tabset .tabset-fade} 

## Population density



```{r}
# Read in data
str_name<-'NPL_ppp_2015_adj_v2.tif' 
r <- raster(str_name)
# Get Nepal shapefile
nep2 <- getData(name = 'GADM', country = 'NPL', level = 2)
# Get pyuthan
pyuthan <- nep2[56,]
# Subset the raster
r_sub <- crop(r, extent(pyuthan))
r <- mask(r_sub, pyuthan)

# Subset elevation
elevation <- nepal::elevation
r_elevation <- crop(elevation, extent(pyuthan))
r_elevation <- mask(r_elevation, pyuthan)

# rr <- mask(r, pyuthan)
# plot(rr)
colr <- colorRampPalette(c('grey', rev(brewer.pal(11, 'RdYlBu'))))
breaks <- c(0, 1, 2, 3, 4, 5, 10, 20, 40, 60, 100)
# levelplot(r, 
#           margin=FALSE,                       # suppress marginal graphics
#           colorkey=list(
#             space='right',                   # plot legend at bottom
#             labels=list(at=breaks, font=4)      # legend ticks and labels 
#           ),    
#           par.settings=list(
#             axis.line=list(col='transparent') # suppress axes and legend outline
#           ),
#           scales=list(draw=FALSE),            # suppress axis labels
#           col.regions=colr,                   # colour ramp
#           at = breaks
#           # at=seq(-5, 5, len=101)
#           ) +
#   layer(sp.polygons(pyuthan, lwd=3)) 
```


```{r}
library(leaflet.extras)
rx <- r
# values(rx)[values(rx) == 0] <- NA
pal <- colorNumeric(c('black', "#0C2C84", "#41B6C4", "#FFFFCC", 'red', 'darkred'), values(rx),
  na.color = "transparent")
# pal <- colorRampPalette(c('grey', rev(brewer.pal(11, 'RdYlBu'))))


leaflet() %>% addTiles() %>%
  addRasterImage(rx, colors = pal, opacity = 0.8) %>%
  addLegend(pal = pal, values = values(rx),
    title = "Population per 100m-squared") %>%
  addPulseMarkers(lat=28.1040711,lng = 82.852954,
    label='District Hospital',
    icon = makePulseIcon(heartbeat = 0.5)) %>%
    addDrawToolbar(targetGroup = 'model',
    editOptions = editToolbarOptions(
      selectedPathOptions = selectedPathOptions())) %>%
  addMeasurePathToolbar(options =
                          measurePathOptions(imperial = FALSE,
                                             minPixelDistance = 0,
                                             showDistances = TRUE)) %>%
  addSearchGoogle() %>%
  # addReverseSearchOSM() %>%
  addResetMapButton()
```

## Distance measurer

```{r}
leaflet() %>% addTiles() %>%
  addPolygons(data = pyuthan, fillOpacity = 0.1, opacity = 0.3) %>%
  addPulseMarkers(lat=28.1040711,lng = 82.852954,
    label='District Hospital',
    icon = makePulseIcon(heartbeat = 0.5)) %>%
    addDrawToolbar(targetGroup = 'model',
    editOptions = editToolbarOptions(
      selectedPathOptions = selectedPathOptions())) %>%
  addMeasurePathToolbar(options =
                          measurePathOptions(imperial = FALSE,
                                             minPixelDistance = 0,
                                             showDistances = TRUE)) %>%
  addSearchGoogle()
```

## Reverse geocoder

```{r}
leaflet() %>% addTiles() %>%
  addPolygons(data = pyuthan, fillOpacity = 0.1, opacity = 0.3) %>%
  addReverseSearchOSM() %>%
  addResetMapButton() %>%
    addPulseMarkers(lat=28.1040711,lng = 82.852954,
    label='District Hospital',
    icon = makePulseIcon(heartbeat = 0.5)) %>%
    addDrawToolbar(targetGroup = 'model',
    editOptions = editToolbarOptions(
      selectedPathOptions = selectedPathOptions())) 
```



```{r, eval = FALSE}
## Satellite


leaflet() %>% 
  addProviderTiles(providers$Esri.WorldImagery) %>%
  addPolygons(data = pyuthan, fillOpacity = 0.1, opacity = 0.3) %>%
  addPulseMarkers(lat=28.1040711,lng = 82.852954,
    label='District Hospital',
    icon = makePulseIcon(heartbeat = 0.5)) %>%
    addDrawToolbar(targetGroup = 'model',
    editOptions = editToolbarOptions(
      selectedPathOptions = selectedPathOptions())) 

## Elevation

# values(r_elevation)[!is.finite(values(r_elevation))] <- 0
pal <- colorNumeric(c('black', 'blue', 'darkgreen', 'brown'), values(r_elevation),
  na.color = "transparent")

leaflet() %>% addProviderTiles(providers$Stamen.Toner) %>%
  addRasterImage(r_elevation, colors = pal, opacity = 0.8) %>%
  addLegend(pal = pal, values = values(r_elevation),
    title = "Elevation (meters)") %>%
  addPulseMarkers(lat=28.1040711,lng = 82.852954,
    label='District Hospital',
    icon = makePulseIcon(heartbeat = 0.5)) %>%
    addDrawToolbar(targetGroup = 'model',
    editOptions = editToolbarOptions(
      selectedPathOptions = selectedPathOptions())) %>%
  addSearchGoogle() %>%
  addReverseSearchOSM() %>%
  addResetMapButton()

values(r)[is.na(values(r))] <- 0
v <- values(r)
a <- length(values(r))
x <- data_frame(v = v,
                n = 1:a)
x <- x %>%
  arrange(desc(v))
x <- x %>%
  mutate(cs = cumsum(v)) %>%
  mutate(p = cs / sum(v) * 100)
x$percentile <- 1:nrow(x) / nrow(x) * 100

plot(x$percentile, x$p, type = 'l')
q50 <- x$percentile[which.min([x$p - 50])]
```

